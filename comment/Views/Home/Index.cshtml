@using comment.Data.Model
@model comment.Data.Model.RECaptcha
@{
    ViewData["Title"] = "Home page";
    var comments = ViewBag.Comment as List<Comment>;
}

@{/*
<div id="dvCaptcha">
</div>
<input type="hidden" id="hfCaptcha" />
<span id="rfvCaptcha" class="error" style="display:none">Captcha validation is required.</span>
<br />
<input type="button" id="btnSubmit" value="Submit" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit"
        async defer></script>
<script type="text/javascript">
    var onloadCallback = function () {
        grecaptcha.render('dvCaptcha', {
            'sitekey': '6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI',
            'callback': function (response) {
                $.ajax({
                    type: "POST",
                    url: "/Home/AjaxMethod",
                    data: {response: response },
                    success: function (r) {
                        var captchaResponse = jQuery.parseJSON(r.Response);
                        if (captchaResponse.success) {
                            $("#hfCaptcha").val(captchaResponse.success);
                            $("#rfvCaptcha").hide();
                        } else {
                            $("#hfCaptcha").val("");
                            $("#rfvCaptcha").show();
                            var error = captchaResponse["error-codes"][0];
                            $("#rfvCaptcha").html("RECaptcha error. " + error);
                        }
                    }
                });
            }
        });
    };
    $(function () {
        $("#btnSubmit").click(function () {
            $("#rfvCaptcha").hide();
            if ($("#hfCaptcha").val() == "") {
                $("#rfvCaptcha").show();
            }
        });
    });
</script>
*/}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Комментарии</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        .comment-box {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .reply {
            margin-left: 30px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Комментарии</h2>

        @if (comments != null && comments.Any())
        {
            <div id="comments-container">
                @foreach (var comment in comments.Where(c => c.ParentId == null))
                {
                    <div class="comment-box">
                        <strong>@comment.UserName</strong> <small>@comment.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                        <p>@comment.Text</p>
                        @if (comment.Attachments.Any())
                        {
                            <p>Прикрепленные файлы:</p>
                            @foreach (var file in comment.Attachments)
                            {
                                if (file.FileType == Microsoft.Graph.Models.AttachmentType.File)
                                {
                                    <a href="@file.FilePath" data-lightbox="image-@comment.Id">
                                        <img src="@file.FilePath" width="150">
                                    </a>
                                }
                                else
                                {
                                    <a href="@file.FilePath" download>Скачать файл</a>
                                }
                            }
                        }
                        <button class="btn btn-sm btn-primary reply-btn" data-id="@comment.Id">Ответить</button>

                        <div class="reply hidden" id="reply-form-@comment.Id"></div>

                        @if (comments.Any(c => c.ParentId == comment.Id))
                        {
                            <div class="reply">
                                @foreach (var reply in comments.Where(c => c.ParentId == comment.Id))
                                {
                                    <div class="comment-box">
                                        <strong>@reply.UserName</strong> <small>@reply.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                        <p>@reply.Text</p>
                                        @if (comment.Attachments.Any())
                                        {
                                            <p>Прикрепленные файлы:</p>
                                            @foreach (var file in comment.Attachments)
                                            {
                                                if (file.FileType == Microsoft.Graph.Models.AttachmentType.File)
                                                {
                                                    <a href="@file.FilePath" data-lightbox="image-@comment.Id">
                                                        <img src="@file.FilePath" width="150">
                                                    </a>
                                                }
                                                else
                                                {
                                                    <a href="@file.FilePath" download>Скачать файл</a>
                                                }
                                            }
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <p>Комментариев пока нет.</p>
        }

        <button class="btn btn-success mt-3" id="show-comment-form">Создать комментарий</button>

        <div id="comment-form-container" class="hidden">
            <h3>Добавить комментарий</h3>
            <form method="post" action="/Comment/Add" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="userName" class="form-label">Имя</label>
                    <input type="text" class="form-control" name="UserName" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" name="Email" required>
                </div>
                <div class="mb-3">
                    <label for="homePage" class="form-label">Домашняя страница (опционально)</label>
                    <input type="url" class="form-control" name="HomePage">
                </div>
                <div class="mb-3">
                    <label for="text" class="form-label">Комментарий</label>
                    <textarea class="form-control" id="text" name="Text" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="files" class="form-label">Прикрепить файлы</label>
                    <input type="file" class="form-control" name="Files" id="files" multiple>
                    <small>Допустимые форматы: JPG, GIF, PNG, TXT (≤ 100 КБ)</small>
                </div>
                <button type="submit" class="btn btn-success">Отправить</button>
            </form>

            <!-- Lightbox для предпросмотра изображений -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>

        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const commentFormContainer = document.getElementById("comment-form-container");
            const showCommentFormBtn = document.getElementById("show-comment-form");

            showCommentFormBtn.addEventListener("click", function() {
                commentFormContainer.classList.toggle("hidden");
            });

            document.querySelectorAll(".reply-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    let commentId = this.getAttribute("data-id");
                    let replyFormContainer = document.getElementById("reply-form-" + commentId);

                    if (!replyFormContainer.innerHTML) {
                        replyFormContainer.innerHTML = `
                            <h5>Ответ на комментарий</h5>
                            <form method="post" action="/Comment/Reply">
                                <input type="hidden" name="ParentId" value="${commentId}">
                                <div class="mb-3">
                                    <label for="userName" class="form-label">Имя</label>
                                    <input type="text" class="form-control" name="UserName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" name="Email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="homePage" class="form-label">Домашняя страница (опционально)</label>
                                    <input type="url" class="form-control" name="HomePage">
                                </div>
                                <div class="mb-3">
                                    <label for="text" class="form-label">Комментарий</label>
                                    <textarea class="form-control" name="Text" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-sm btn-success">Ответить</button>
                            </form>`;
                    }

                    replyFormContainer.classList.toggle("hidden");
                });
            });
        });
    </script>

</body>
</html>